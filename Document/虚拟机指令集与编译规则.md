# 虚拟机指令

## 寄存器

AX	结果寄存器
SP	栈寄存器，表示栈顶位置
PC	程序寄存器，表示待执行的指令

## 基础指令

### 栈基本操作

IMOV \<val\>	将AX寄存器赋值为val
PUSH	将AX压栈
IPUSH \<val\>	将立即数val压栈
TOP	将AX赋值为栈顶元素
POP	栈顶元素出栈

### 栈、堆读写

LFS	以栈顶元素的值为栈顶偏移量（0为栈顶，-1为次顶），将AX赋值为栈上该地址的值
STS	以栈顶元素的值为栈顶偏移量（0为栈顶，-1为次顶），将栈上该地址的值赋值为AX
LFH	以栈顶元素的值为地址，将AX赋值为堆上该地址的值
STH	以栈顶元素的值为地址，将堆上该地址的值赋值为AX

### 流程控制

JMP \<addr\>	将PC赋值为addr
JZ \<addr\>	若AX为零，则将PC赋值为addr
JNZ \<addr\>	若AX非零，则将PC赋值为addr

CALL \<addr\>	将函数执行后本该执行的下一条指令的位置压栈，跳转到函数addr处开始执行
CALLS	将栈顶元素出栈作为 addr 执行 call
RET	将栈顶元素出栈，将其赋值给 PC
***函数的参数需要调用者压栈，并在调用结束后清理压栈参数***

## 算术运算

ADD	栈顶元素作为加数出栈，AX作为另一加数，将和压栈
SUB	栈顶元素作为被减数出栈，AX作为减数，将差压栈
NEG	将AX求负的结果压栈
MUL	栈顶元素作为因数出栈，AX作为另一因数，将积压栈
DIV	栈顶元素作为被除数出栈，AX作为除数，将商压栈
MOD	栈顶元素作为被除数出栈，AX作为除数，将模压栈
POW	栈顶元素作为底数出栈，AX作为指数，将乘方压栈

## 逻辑运算

AND	栈顶元素出栈，和AX逻辑与后将结果压栈
OR	栈顶元素出栈，和AX逻辑或后将结果压栈
NOT	将AX逻辑非的结果压栈

EQ	栈顶元素出栈，如果栈顶元素等于AX，将true压栈，否则压栈false
NEQ	栈顶元素出栈，如果栈顶元素不等于AX，将true压栈，否则压栈false
LT	栈顶元素出栈，如果栈顶元素小于AX，将true压栈，否则压栈false
LE	栈顶元素出栈，如果栈顶元素不大于AX，将true压栈，否则压栈false
GT	栈顶元素出栈，如果栈顶元素大于AX，将true压栈，否则压栈false
GE	栈顶元素出栈，如果栈顶元素不小于AX，将true压栈，否则压栈false

## 字符串操作

STRSUB	将位于AX的字符串截取[pos, pos+length) 的子串，并将新串的地址存入AX（记栈顶元素为length, 次顶元素为pos，操作结束后出栈）
STRCON	将位于AX的字符串与位于pos的字符串连接，该操作为in-place操作,操作后的结果串存在AX中（记栈顶元素为pos，操作结束后出栈）
STRLEN	计算位于AX的字符串的长度，并将结果存入AX
STRCPY	将位于AX的字符串复制一个副本，并将新串的地址存入AX
STRADD	将位于AX的字符串后连接一个字符ch（记栈顶元素为ch，操作结束后出栈）
STRCMP	将位于pos的字符串与位于AX的字符串逐位比较，并将首位不相同的值做差存入AX（记栈顶元素为pos，操作结束后出栈）
STRFMT	将AX按照%d格式化为字符串，并将新串的地址存入AX

## 字典操作

DICADD	将位于AX的字典中添加一个键值对，用栈顶元素作为键，用次顶元素所表示的符号作为值，如果键已存在，则覆盖原有的键值对
DICDEL	将位于AX的字典中，以栈顶元素为键的键值对删除
DICCPY	将位于AX的字典复制一个副本，并将副本的地址存入AX
DICLEN	计算位于AX的字典的键值对数量，并将结果存入AX
DICKEY	获取位于AX的字典的键集合，并将其创建为新数组，地址存入AX

## 系统指令

PRINT	将位于AX的字符串输出



# 编译规则

1.编译单条语句时，执行前后栈必须保持平衡